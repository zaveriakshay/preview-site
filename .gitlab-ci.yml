# GitLab CI/CD Pipeline for noqodi Documentation
# This pipeline includes automatic changelog generation

stages:
  - prepare
  - changelog
  - build
  - test
  - deploy

variables:
  NODE_VERSION: "18"
  DOCKER_IMAGE: "node:18-alpine"

# Cache node modules for faster builds
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .pnpm-store/

# Install dependencies
prepare:
  stage: prepare
  image: $DOCKER_IMAGE
  before_script:
    - npm install -g pnpm
  script:
    - pnpm config set store-dir .pnpm-store
    - pnpm install --frozen-lockfile
  artifacts:
    paths:
      - node_modules/
      - .pnpm-store/
    expire_in: 1 hour

# Generate changelog from Git history and releases
generate_changelog:
  stage: changelog
  image: $DOCKER_IMAGE
  dependencies:
    - prepare
  before_script:
    - apk add --no-cache git jq curl
    - npm install -g pnpm
  script:
    - echo "Generating changelog from Git history..."
    
    # Create changelog directory if it doesn't exist
    - mkdir -p src/content/docs/en/changelogs
    - mkdir -p src/content/docs/ar/changelogs
    
    # Get latest release info from GitLab API
    - |
      if [ -n "$CI_PROJECT_ID" ] && [ -n "$GITLAB_TOKEN" ]; then
        echo "Fetching release information from GitLab API..."
        
        # Get latest releases
        RELEASES=$(curl -s --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
          "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases?per_page=10")
        
        # Get recent commits since last release
        LAST_RELEASE_TAG=$(echo "$RELEASES" | jq -r '.[0].tag_name // "HEAD~50"')
        
        echo "Processing commits since: $LAST_RELEASE_TAG"
        
        # Generate changelog entry for current build
        cat > changelog_template.sh << 'EOL'
      #!/bin/sh
      
      # Extract commit information
      COMMIT_RANGE="${LAST_RELEASE_TAG}..HEAD"
      DATE=$(date +%Y-%m-%d)
      VERSION=${CI_COMMIT_TAG:-"dev-${CI_COMMIT_SHORT_SHA}"}
      BUILD_NUMBER=${CI_PIPELINE_ID:-"local"}
      
      # Determine change type based on commit messages
      CHANGE_TYPE="platform"
      CATEGORY="update"
      
      if git log --oneline $COMMIT_RANGE | grep -i "api\|endpoint"; then
        CHANGE_TYPE="api"
      elif git log --oneline $COMMIT_RANGE | grep -i "sdk\|library"; then
        CHANGE_TYPE="sdk"
      elif git log --oneline $COMMIT_RANGE | grep -i "docs\|documentation"; then
        CHANGE_TYPE="documentation"
      fi
      
      if [ -n "$CI_COMMIT_TAG" ]; then
        if echo "$CI_COMMIT_TAG" | grep -E "^v[0-9]+\.0\.0"; then
          CATEGORY="major-release"
        else
          CATEGORY="release"
        fi
      elif git log --oneline $COMMIT_RANGE | grep -i "hotfix\|critical"; then
        CATEGORY="hotfix"
      fi
      
      # Extract meaningful changes
      FEATURES=$(git log $COMMIT_RANGE --grep="feat\|feature" --oneline --pretty=format:"- %s" | head -5)
      FIXES=$(git log $COMMIT_RANGE --grep="fix\|bug" --oneline --pretty=format:"- %s" | head -5)
      IMPROVEMENTS=$(git log $COMMIT_RANGE --grep="improve\|enhance\|update" --oneline --pretty=format:"- %s" | head -5)
      
      # Generate English changelog
      cat > "src/content/docs/en/changelogs/${DATE}-${CHANGE_TYPE}-${CI_COMMIT_SHORT_SHA}.md" << EOF
      ---
      title: "${CHANGE_TYPE^} Updates - $(date '+%B %d, %Y')"
      date: "${DATE}"
      version: "${VERSION}"
      type: "${CHANGE_TYPE}"
      category: "${CATEGORY}"
      author: "noqodi Development Team"
      tags: ["${CHANGE_TYPE}", "ci-cd", "automated"]
      ---
      
      # ${CHANGE_TYPE^} Updates - $(date '+%B %d, %Y')
      
      **Release Version:** ${VERSION}  
      **Release Date:** $(date '+%B %d, %Y')  
      **Type:** ${CHANGE_TYPE^} Update
      
      ## ðŸ”„ Changes in this Release
      
      This release includes the following changes:
      
      ### ðŸš€ New Features
      ${FEATURES:-"- No new features in this release"}
      
      ### ðŸ› Bug Fixes
      ${FIXES:-"- No bug fixes in this release"}
      
      ### ðŸ”§ Improvements
      ${IMPROVEMENTS:-"- General improvements and maintenance"}
      
      ## ðŸ“Š Build Information
      
      - **Build Number**: #${BUILD_NUMBER}
      - **Commit Range**: \`${COMMIT_RANGE}\`
      - **Pipeline**: [${CI_PIPELINE_ID}](${CI_PIPELINE_URL})
      - **Commit**: [${CI_COMMIT_SHORT_SHA}](${CI_PROJECT_URL}/-/commit/${CI_COMMIT_SHA})
      
      ## ðŸ”— Related Links
      
      - [View Full Commit History](${CI_PROJECT_URL}/-/commits/${CI_COMMIT_REF_NAME})
      - [Pipeline Details](${CI_PIPELINE_URL})
      
      ---
      
      **Generated automatically from GitLab CI/CD Pipeline**  
      **Commit**: \`${CI_COMMIT_SHORT_SHA}\`  
      **Build**: #${BUILD_NUMBER}
      EOF
      
      # Generate Arabic changelog (simplified translation)
      cat > "src/content/docs/ar/changelogs/${DATE}-${CHANGE_TYPE}-${CI_COMMIT_SHORT_SHA}.md" << EOF
      ---
      title: "ØªØ­Ø¯ÙŠØ«Ø§Øª ${CHANGE_TYPE} - $(date '+%B %d, %Y')"
      date: "${DATE}"
      version: "${VERSION}"
      type: "${CHANGE_TYPE}"
      category: "${CATEGORY}"
      author: "ÙØ±ÙŠÙ‚ ØªØ·ÙˆÙŠØ± Ù†Ù‚ÙˆØ¯ÙŠ"
      tags: ["${CHANGE_TYPE}", "ci-cd", "ØªÙ„Ù‚Ø§Ø¦ÙŠ"]
      ---
      
      # ØªØ­Ø¯ÙŠØ«Ø§Øª ${CHANGE_TYPE} - $(date '+%B %d, %Y')
      
      **Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚:** ${VERSION}  
      **ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚:** $(date '+%B %d, %Y')  
      **Ø§Ù„Ù†ÙˆØ¹:** ØªØ­Ø¯ÙŠØ« ${CHANGE_TYPE}
      
      ## ðŸ”„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±
      
      ÙŠØªØ¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:
      
      ### ðŸš€ Ù…ÙŠØ²Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
      ${FEATURES:-"- Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙŠØ²Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±"}
      
      ### ðŸ› Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
      ${FIXES:-"- Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±"}
      
      ### ðŸ”§ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª
      ${IMPROVEMENTS:-"- ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¹Ø§Ù…Ø© ÙˆØµÙŠØ§Ù†Ø©"}
      
      ## ðŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
      
      - **Ø±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡**: #${BUILD_NUMBER}
      - **Ù†Ø·Ø§Ù‚ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…**: \`${COMMIT_RANGE}\`
      - **Ø®Ø· Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨**: [${CI_PIPELINE_ID}](${CI_PIPELINE_URL})
      - **Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…**: [${CI_COMMIT_SHORT_SHA}](${CI_PROJECT_URL}/-/commit/${CI_COMMIT_SHA})
      
      ## ðŸ”— Ø±ÙˆØ§Ø¨Ø· Ø°Ø§Øª ØµÙ„Ø©
      
      - [Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„ÙƒØ§Ù…Ù„](${CI_PROJECT_URL}/-/commits/${CI_COMMIT_REF_NAME})
      - [ØªÙØ§ØµÙŠÙ„ Ø®Ø· Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨](${CI_PIPELINE_URL})
      
      ---
      
      **ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø®Ø· Ø£Ù†Ø§Ø¨ÙŠØ¨ GitLab CI/CD**  
      **Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…**: \`${CI_COMMIT_SHORT_SHA}\`  
      **Ø§Ù„Ø¨Ù†Ø§Ø¡**: #${BUILD_NUMBER}
      EOF
      
      echo "Generated changelog entries:"
      echo "- src/content/docs/en/changelogs/${DATE}-${CHANGE_TYPE}-${CI_COMMIT_SHORT_SHA}.md"
      echo "- src/content/docs/ar/changelogs/${DATE}-${CHANGE_TYPE}-${CI_COMMIT_SHORT_SHA}.md"
      EOL
        
        chmod +x changelog_template.sh
        ./changelog_template.sh
        
      else
        echo "GitLab API token not available, creating sample changelog..."
        
        # Create sample changelog entry
        DATE=$(date +%Y-%m-%d)
        cat > "src/content/docs/en/changelogs/${DATE}-build-${CI_COMMIT_SHORT_SHA}.md" << EOF
      ---
      title: "Build Update - $(date '+%B %d, %Y')"
      date: "${DATE}"
      version: "build-${CI_COMMIT_SHORT_SHA}"
      type: "platform"
      category: "update"
      author: "CI/CD Pipeline"
      tags: ["build", "automated"]
      ---
      
      # Build Update - $(date '+%B %d, %Y')
      
      **Build**: #${CI_PIPELINE_ID:-"local"}  
      **Commit**: ${CI_COMMIT_SHORT_SHA}  
      **Date**: $(date '+%B %d, %Y')
      
      This is an automated build update generated during the CI/CD process.
      
      ## Changes
      
      - Documentation updates
      - Build improvements
      - General maintenance
      
      ---
      
      **Generated from CI/CD Pipeline**
      EOF
        
      fi
    
    # Validate generated files
    - |
      echo "Validating generated changelog files..."
      for file in src/content/docs/*/changelogs/*.md; do
        if [ -f "$file" ]; then
          echo "âœ“ Generated: $file"
          # Check if file has valid frontmatter
          if head -n 10 "$file" | grep -q "^---$"; then
            echo "  âœ“ Valid frontmatter detected"
          else
            echo "  âš  Warning: No frontmatter detected in $file"
          fi
        fi
      done
    
  artifacts:
    paths:
      - src/content/docs/en/changelogs/
      - src/content/docs/ar/changelogs/
    expire_in: 1 week
    reports:
      dotenv: changelog.env
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG
    - if: $CI_MERGE_REQUEST_IID

# Build the Astro documentation site
build:
  stage: build
  image: $DOCKER_IMAGE
  dependencies:
    - prepare
    - generate_changelog
  before_script:
    - npm install -g pnpm
  script:
    - echo "Building Astro documentation site..."
    - pnpm config set store-dir .pnpm-store
    - pnpm run build
    
    # Validate build output
    - |
      if [ -d "dist" ]; then
        echo "âœ“ Build successful - dist directory created"
        echo "Build size: $(du -sh dist)"
        
        # Check for changelog pages
        if find dist -name "*changelog*" -type f | head -5; then
          echo "âœ“ Changelog pages found in build output"
        else
          echo "âš  Warning: No changelog pages found in build output"
        fi
      else
        echo "âœ— Build failed - no dist directory found"
        exit 1
      fi
  artifacts:
    paths:
      - dist/
    expire_in: 1 day

# Run tests and linting
test:
  stage: test
  image: $DOCKER_IMAGE
  dependencies:
    - prepare
  before_script:
    - npm install -g pnpm
  script:
    - echo "Running tests and linting..."
    - pnpm config set store-dir .pnpm-store
    
    # Run linting if script exists
    - |
      if pnpm run --if-present lint; then
        echo "âœ“ Linting passed"
      else
        echo "âš  No linting script found or linting failed"
      fi
    
    # Run type checking if script exists
    - |
      if pnpm run --if-present typecheck; then
        echo "âœ“ Type checking passed"  
      else
        echo "âš  No type checking script found or type checking failed"
      fi
    
    # Test changelog generation
    - |
      echo "Testing changelog functionality..."
      if [ -f "src/utils/changelog.ts" ]; then
        echo "âœ“ Changelog utilities found"
      else
        echo "âš  Changelog utilities not found"
      fi
      
      # Check for changelog content
      CHANGELOG_COUNT=$(find src/content/docs -name "*.md" -path "*/changelogs/*" | wc -l)
      echo "Found $CHANGELOG_COUNT changelog entries"
      
      if [ "$CHANGELOG_COUNT" -gt 0 ]; then
        echo "âœ“ Changelog entries exist"
      else
        echo "âš  No changelog entries found"
      fi
  allow_failure: true

# Deploy to staging/production
deploy_staging:
  stage: deploy
  image: $DOCKER_IMAGE
  dependencies:
    - build
  script:
    - echo "Deploying to staging environment..."
    - echo "Build artifacts ready for deployment"
    - echo "Changelog pages included in deployment"
  environment:
    name: staging
    url: https://staging-docs.noqodi.com
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

deploy_production:
  stage: deploy
  image: $DOCKER_IMAGE
  dependencies:
    - build
  script:
    - echo "Deploying to production environment..."
    - echo "Build artifacts ready for deployment"
    - echo "Changelog pages included in deployment"
  environment:
    name: production
    url: https://docs.noqodi.com
  rules:
    - if: $CI_COMMIT_TAG
  when: manual

# Cleanup job for old changelog entries (optional)
cleanup_old_changelogs:
  stage: deploy
  image: $DOCKER_IMAGE
  script:
    - echo "Cleaning up old changelog entries..."
    - |
      # Keep only last 100 changelog entries per language to prevent repo bloat
      for lang in en ar; do
        CHANGELOG_DIR="src/content/docs/$lang/changelogs"
        if [ -d "$CHANGELOG_DIR" ]; then
          cd "$CHANGELOG_DIR"
          # Get files sorted by date (newest first), skip first 100, delete the rest
          ls -t *.md 2>/dev/null | tail -n +101 | xargs -r rm -f
          echo "Cleaned up old changelog entries for $lang"
          cd - > /dev/null
        fi
      done
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "schedule"
  when: manual